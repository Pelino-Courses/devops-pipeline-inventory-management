name: Project Automation - Move to In Progress

on:
  issues:
    types: [assigned]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  move-assigned-to-in-progress:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'assigned'
    
    steps:
      - name: Move assigned issue to In Progress
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const projectNumber = 35;
            const orgName = 'Pelino-Courses';
            const statusFieldName = 'Status';
            const targetStatus = 'In Progress';
            
            console.log(`Processing issue #${issue.number}: ${issue.title}`);
            console.log(`Assignee: ${context.payload.assignee.login}`);
            
            try {
              // Step 1: Get the project ID and fields
              const projectQuery = `
                query($org: String!, $number: Int!) {
                  organization(login: $org) {
                    projectV2(number: $number) {
                      id
                      fields(first: 20) {
                        nodes {
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options {
                              id
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const projectResult = await github.graphql(projectQuery, {
                org: orgName,
                number: projectNumber
              });
              
              const project = projectResult.organization.projectV2;
              console.log(`Found project: ${project.id}`);
              
              // Step 2: Find the Status field and In Progress option
              const statusField = project.fields.nodes.find(
                field => field.name === statusFieldName
              );
              
              if (!statusField) {
                console.log(`Status field not found`);
                return;
              }
              
              const inProgressOption = statusField.options.find(
                option => option.name === targetStatus
              );
              
              if (!inProgressOption) {
                console.log(`"${targetStatus}" option not found in Status field`);
                return;
              }
              
              console.log(`Status field ID: ${statusField.id}`);
              console.log(`In Progress option ID: ${inProgressOption.id}`);
              
              // Step 3: Get the project item ID for this issue
              const itemQuery = `
                query($org: String!, $number: Int!) {
                  organization(login: $org) {
                    projectV2(number: $number) {
                      items(first: 100) {
                        nodes {
                          id
                          content {
                            ... on Issue {
                              number
                              repository {
                                name
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const itemResult = await github.graphql(itemQuery, {
                org: orgName,
                number: projectNumber
              });
              
              const projectItem = itemResult.organization.projectV2.items.nodes.find(
                item => item.content?.number === issue.number && 
                        item.content?.repository?.name === context.repo.repo
              );
              
              if (!projectItem) {
                console.log(`Issue #${issue.number} not found in project`);
                return;
              }
              
              console.log(`Project item ID: ${projectItem.id}`);
              
              // Step 4: Update the status field
              const updateMutation = `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: String!) {
                  updateProjectV2ItemFieldValue(
                    input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: {
                        singleSelectOptionId: $value
                      }
                    }
                  ) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `;
              
              await github.graphql(updateMutation, {
                projectId: project.id,
                itemId: projectItem.id,
                fieldId: statusField.id,
                value: inProgressOption.id
              });
              
              console.log(`âœ… Successfully moved issue #${issue.number} to "${targetStatus}"`);
              
            } catch (error) {
              console.error('Error updating project:', error);
              core.setFailed(error.message);
            }
