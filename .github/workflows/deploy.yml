name: Deploy to Azure VM with Ansible

# DEPRECATED: This workflow is superseded by CD Pipeline (cd-pipeline.yml)
# Keeping for reference but disabling automatic triggers
on:
  workflow_dispatch:  # Manual trigger only

# Original triggers (now disabled):
# push:
#   branches:
#     - main
#     - develop
#     - debug-deployment
#   paths:
#     - 'backend/**'
#     - 'frontend/**'
#     - 'ansible/**'
#     - 'docker-compose.yml'

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible
          pip install ansible-core
          
      - name: Install Ansible Collections
        run: |
          cd ansible
          ansible-galaxy collection install -r requirements.yml

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VM_PUBLIC_IP }} >> ~/.ssh/known_hosts

      - name: Create Ansible inventory
        run: |
          cat > ansible/inventory/hosts << EOF
          [azure_vms]
          devops-vm ansible_host=${{ secrets.VM_PUBLIC_IP }} ansible_user=azureuser ansible_ssh_private_key_file=~/.ssh/id_rsa

          [azure_vms:vars]
          ansible_python_interpreter=/usr/bin/python3
          ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          EOF

      - name: Test Ansible connectivity
        run: |
          cd ansible
          ansible all -i inventory/hosts -m ping
        env:
          ANSIBLE_HOST_KEY_CHECKING: 'False'

      - name: Run Ansible deployment
        run: |
          cd ansible
          echo "Current directory:"
          pwd
          echo "Listing files:"
          ls -R
          echo "Checking inventory content:"
          cat inventory/hosts
          echo "Checking ansible-playbook version:"
          ansible-playbook --version
          echo "Running playbook with verbose output:"
          ansible-playbook -i inventory/hosts playbooks/setup-server.yml -vvv
        env:
          ACR_NAME: ${{ secrets.ACR_NAME }}
          ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          IMAGE_TAG: ${{ github.sha }}
          ANSIBLE_HOST_KEY_CHECKING: 'False'
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}

      - name: Verify deployment
        run: |
          sleep 30
          curl -f http://${{ secrets.VM_PUBLIC_IP }}:3000/health || exit 1
          echo "âœ… Deployment successful!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ðŸŽ‰ Deployment completed successfully!"
            echo "Frontend: http://${{ secrets.VM_PUBLIC_IP }}"
            echo "Backend: http://${{ secrets.VM_PUBLIC_IP }}:3000"
          else
            echo "âŒ Deployment failed!"
            exit 1
          fi
