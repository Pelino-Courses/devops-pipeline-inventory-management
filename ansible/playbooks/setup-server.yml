---
- name: Configure DevOps Application Server
  hosts: azure_vms
  become: yes
  gather_facts: yes

  vars:
    acr_name: "{{ lookup('env', 'ACR_NAME') }}"
    acr_login_server: "{{ lookup('env', 'ACR_LOGIN_SERVER') }}"
    backend_image_name: "devops-backend"
    frontend_image_name: "devops-frontend"
    image_tag: "{{ lookup('env', 'IMAGE_TAG') | default('latest', true) }}"
    db_user: "{{ lookup('env', 'DB_USER') }}"
    db_password: "{{ lookup('env', 'DB_PASSWORD') }}"
    db_name: "{{ lookup('env', 'DB_NAME') }}"

  pre_tasks:
    - name: Display target host information
      debug:
        msg: "Configuring {{ inventory_hostname }} ({{ ansible_host }})"

    - name: Clean up corrupted Docker repository configurations
      shell: |
        rm -f /etc/apt/sources.list.d/docker.list
        rm -f /etc/apt/sources.list.d/download_docker_com_linux_ubuntu.list
        rm -f /etc/apt/keyrings/docker.gpg
        apt-key del 8D81803C0EBFCD88 2>/dev/null || true
        apt-key del 7EA0A9C3F273FCD8 2>/dev/null || true
      ignore_errors: true
      changed_when: false

    - name: Force apt cache refresh after cleanup
      shell: apt-get clean && apt-get update
      ignore_errors: true
      changed_when: false

  roles:
    - security
    - docker
    - app-deploy

  post_tasks:
    - name: Verify application is running
      uri:
        url: "http://localhost:3000/health"
        status_code: 200
      register: health_check
      until: health_check.status == 200
      retries: 5
      delay: 3

    - name: Display deployment summary
      debug:
        msg:
          - "Deployment completed successfully"
          - "Application URL: http://{{ ansible_host }}"
          - "Backend Health: http://{{ ansible_host }}:3000/health"
