---
- name: Create application directory
  file:
    path: /opt/devops-app
    state: directory
    owner: "{{ ansible_user }}"
    group: docker
    mode: '0755'

- name: Login to Azure CLI with Service Principal
  shell: |
    az login --service-principal \
      --username {{ lookup('env', 'ARM_CLIENT_ID') }} \
      --password {{ lookup('env', 'ARM_CLIENT_SECRET') }} \
      --tenant {{ lookup('env', 'ARM_TENANT_ID') }}
  when: lookup('env', 'ARM_CLIENT_ID') | length > 0

- name: Login to Azure Container Registry
  shell: az acr login --name {{ acr_name }}
  when: lookup('env', 'ARM_CLIENT_ID') | length > 0

- name: Login to ACR with Docker
  community.docker.docker_login:
    registry_url: "{{ acr_login_server }}"
    username: "{{ acr_name }}"
    password: "{{ lookup('env', 'ACR_PASSWORD') }}"
    reauthorize: yes

- name: Create docker-compose file
  template:
    src: docker-compose.yml.j2
    dest: /opt/devops-app/docker-compose.yml
    owner: "{{ ansible_user }}"
    mode: '0644'
  notify: Restart application

- name: Create environment file
  template:
    src: dotenv.j2
    dest: /opt/devops-app/.env
    owner: "{{ ansible_user }}"
    mode: '0600'
  notify: Restart application

- name: Pull latest images
  community.docker.docker_compose_v2:
    project_src: /opt/devops-app
    pull: always

- name: Start application containers
  community.docker.docker_compose_v2:
    project_src: /opt/devops-app
    state: present
    recreate: always

- name: Wait for application to be ready
  uri:
    url: "http://localhost:3000/health"
    status_code: 200
  register: result
  until: result.status == 200
  retries: 30
  delay: 2
